
@{
    ViewBag.Title = "JavaScript Mode";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>@ViewBag.Title</h2>

<p>
    <b><a href="@ViewBag.reportUrl" target="_blank">Report URL</a>:</b>
    <br />
    <pre>@ViewBag.reportUrl</pre>
</p>

<div class="alert-danger" id="errorContainer"></div>

<iframe id="reportContainer" style="width:100%;height:90%;overflow:scroll"></iframe>

<script type="text/javascript">
    var xhr = new XMLHttpRequest();

    xhr.open('GET', "@ViewBag.reportUrl", true);
    xhr.withCredentials = "true";
    xhr.onreadystatechange = handler;
    xhr.responseType = 'blob';
    xhr.setRequestHeader('Access-Control-Allow-Origin', '*'); // allow CORS
    xhr.setRequestHeader('Authorization', 'Basic @ViewBag.accessToken'); // inject the basic auth in the request header
    xhr.send();

    function handler() {
        if (this.readyState === this.DONE) {
            if (this.status === 200) {
                // this.response is a Blob, because we set responseType above
                var data_url = URL.createObjectURL(this.response);
                document.querySelector('#reportContainer').src = data_url;
                document.querySelector('#reportContainer').style.display = "block"; // make sure the iframe is visible
            } else {
                // log the error in the browser developer console
                console.error('Response error ' + this.status);
                console.log(this.statusText);

                // display the error in the page
                document.querySelector('#errorContainer').innerHTML = "<h2>Server Response Error!</h2><p>" + this.statusText + "</p>";
                document.querySelector('#reportContainer').style.display = "none"; // hide the iframe
            }
        }
    }

</script>
